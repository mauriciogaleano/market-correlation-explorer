<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Market Correlation Explorer</title>
  <!-- Plotly.js CDN -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <!-- html2canvas for export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- Bootstrap for tooltips & popovers -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #controls { text-align: center; margin-bottom: 15px; }
    #heatmap { width: 100%; max-width: 600px; margin: auto; }
    #exportBtn, .affiliate-btn { margin: 5px; }
    @media (max-width: 600px) {
      #heatmap { max-width: 100%; }
      .affiliate-btn { display: block; width: 80%; margin: 5px auto; }
    }
  </style>
</head>
<body>
  <div class="text-center mb-3">
    <h3 class="d-inline">Market Correlation Explorer</h3>
    <button type="button" class="btn btn-sm btn-outline-secondary ms-2" data-bs-toggle="popover" title="Correlation Info" data-bs-content="1 = Perfect positive; 0 = No correlation; -1 = Perfect negative.">
      ℹ️
    </button>
  </div>

  <div id="controls">
    <select id="rangeSelect" class="form-select form-select-sm d-inline w-auto">
      <option value="1D">1 Day</option>
      <option value="1W" selected>1 Week</option>
      <option value="1M">1 Month</option>
    </select>
    <button id="exportBtn" class="btn btn-primary btn-sm">Export as PNG</button>
  </div>

  <div id="heatmap"></div>
  <div id="affiliates" class="text-center mt-3">
    <a href="https://www.etoro.com/?aff=YOURCODE" target="_blank" class="btn btn-outline-success affiliate-btn">Trade S&P on eToro</a>
    <a href="https://www.binance.com/?ref=YOURCODE" target="_blank" class="btn btn-outline-warning affiliate-btn">Buy Gold on Binance</a>
  </div>

  <script>
    // Static correlation matrices (stub for dynamic API)
    const correlationData = {
      '1D': [
        [1.00, -0.04, 0.08, 0.35, 0.36],
        [-0.04, 1.00, -0.30, 0.01, 0.02],
        [0.08, -0.30, 1.00, 0.18, 0.16],
        [0.35, 0.01, 0.18, 1.00, 0.97],
        [0.36, 0.02, 0.16, 0.97, 1.00]
      ],
      '1W': [
        [1.00, -0.044, 0.076, 0.36, 0.37],
        [-0.044, 1.00, -0.31, 0.0099, 0.02],
        [0.076, -0.31, 1.00, 0.18, 0.16],
        [0.36, 0.0099, 0.18, 1.00, 0.97],
        [0.37, 0.02, 0.16, 0.97, 1.00]
      ],
      '1M': [
        [1.00, -0.05, 0.10, 0.40, 0.42],
        [-0.05, 1.00, -0.28, 0.02, 0.03],
        [0.10, -0.28, 1.00, 0.20, 0.18],
        [0.40, 0.02, 0.20, 1.00, 0.95],
        [0.42, 0.03, 0.18, 0.95, 1.00]
      ]
    };

    const labels = ['Bitcoin', 'Dollar Index', 'Gold', 'S&P 500', 'NASDAQ'];

    // Initialize popovers
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    popoverTriggerList.map(function (popoverTriggerEl) {
      return new bootstrap.Popover(popoverTriggerEl);
    });

    // Plot function
    function plotHeatmap(matrix) {
      const trace = {
        x: labels,
        y: labels,
        z: matrix,
        type: 'heatmap',
        colorscale: 'RdBu',
        reversescale: true,
        hovertemplate: '<b>%{y}</b> vs <b>%{x}</b>: %{z:.2f}<extra></extra>'
      };
      const layout = {
        margin: { t: 20, b: 50, l: 50, r: 20 },
        xaxis: { side: 'bottom' },
        yaxis: { autorange: 'reversed' }
      };
      Plotly.newPlot('heatmap', [trace], layout, {responsive: true});
    }

    // Stub for dynamic data fetch
    async function fetchCorrelation(range) {
      // TODO: replace with real API call, e.g. fetch(`/api/correlation?range=${range}`)
      return correlationData[range];
    }

    // Initial load
    document.addEventListener('DOMContentLoaded', async () => {
      const select = document.getElementById('rangeSelect');
      const matrix = await fetchCorrelation(select.value);
      plotHeatmap(matrix);

      // Range change
      select.addEventListener('change', async () => {
        const data = await fetchCorrelation(select.value);
        plotHeatmap(data);
      });

      // Export functionality
      document.getElementById('exportBtn').addEventListener('click', () => {
        html2canvas(document.getElementById('heatmap')).then(canvas => {
          const link = document.createElement('a');
          link.download = 'correlation_heatmap_' + select.value + '.png';
          link.href = canvas.toDataURL();
          link.click();
        });
      });
    });
  </script>
</body>
</html>
