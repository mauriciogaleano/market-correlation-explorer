<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Market Correlation Explorer - Live Heatmap</title>
  <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #heatmap { width: 100%; max-width: 600px; margin: auto; height: 400px; }
    .text-center { text-align: center; }
    .change-up { color: green; }
    .change-down { color: red; }
    .badge { margin-left: 10px; }
  </style>
</head>
<body>
  <div class="text-center mb-3">
    <h3>Market Correlation Explorer</h3>
    <p id="date"></p>
    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="popover" title="Info" data-bs-content="Live correlation heatmap across assets. Green=positive, red=negative.">ℹ️</button>
  </div>
  <div id="controls" class="text-center mb-3">
    <select id="rangeSelect" class="form-select form-select-sm d-inline w-auto">
      <option value="1">1 Day</option>
      <option value="7" selected>1 Week</option>
      <option value="30">1 Month</option>
    </select>
    <button id="exportBtn" class="btn btn-primary btn-sm ms-2">Export Heatmap as PNG</button>
  </div>
  <div id="loading" class="text-center mb-3" style="display:none;">Loading data...</div>
  <div id="heatmap"></div>
  <div id="prices" class="mt-4">
    <h5 class="text-center">Current Prices & Changes</h5>
    <ul class="list-group list-group-flush">
      <li class="list-group-item">Bitcoin: <span id="priceBTC">...</span> (<span id="changeBTC">...</span>) <span id="sentimentBTC" class="badge bg-info">F&G: ...</span></li>
      <li class="list-group-item">Ethereum: <span id="priceETH">...</span> (<span id="changeETH">...</span>) <span id="sentimentETH" class="badge bg-info">F&G: ...</span></li>
      <li class="list-group-item">Gold: <span id="priceGOLD">...</span></li>
      <li class="list-group-item">S&P 500: <span id="priceSP">...</span></li>
      <li class="list-group-item">NASDAQ: <span id="priceIXIC">...</span></li>
      <li class="list-group-item">Dollar Index: <span id="priceDXY">...</span></li>
    </ul>
  </div>
  <script>
    const symbols = [
      { key: 'BTC', label: 'bitcoin' },
      { key: 'ETH', label: 'ethereum' },
      { key: 'GOLD', label: 'pax-gold' },
      { key: 'SP', label: '^GSPC' },
      { key: 'IXIC', label: '^IXIC' },
      { key: 'DXY', label: '^DXY' }
    ];
    const labels = symbols.map(s => s.key);
    function pearson(x, y) {
      const n = x.length;
      const avg = arr => arr.reduce((a,b) => a + b, 0) / n;
      const mx = avg(x), my = avg(y);
      let num = 0, sx = 0, sy = 0;
      for (let i = 0; i < n; i++) {
        const dx = x[i] - mx, dy = y[i] - my;
        num += dx * dy;
        sx += dx * dx;
        sy += dy * dy;
      }
      return num / Math.sqrt(sx * sy);
    }
    async function fetchSeries(sym, days) {
      if (['bitcoin','ethereum','pax-gold'].includes(sym)) {
        const res = await fetch(`https://api.coingecko.com/api/v3/coins/${sym}/market_chart?vs_currency=usd&days=${days}`);
        const json = await res.json();
        return json.prices.map(p => p[1]);
      }
      const res = await fetch(`https://financialmodelingprep.com/api/v3/historical-price-full/${encodeURIComponent(sym)}?timeseries=${days}&apikey=demo`);
      const json = await res.json();
      return Array.isArray(json.historical) ? json.historical.map(h => h.close).reverse() : [];
    }
    async function fetchPrices() {
      const data = {BTC:'N/A',changeBTC:'N/A',ETH:'N/A',changeETH:'N/A',GOLD:'N/A',SP:'N/A',IXIC:'N/A',DXY:'N/A',FNG:'N/A'};
      try {
        const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,pax-gold&vs_currencies=usd&include_24hr_change=true');
        const json = await res.json();
        data.BTC = `$${json.bitcoin.usd}`;
        data.changeBTC = `${json.bitcoin.usd_24h_change.toFixed(2)}%`;
        data.ETH = `$${json.ethereum.usd}`;
        data.changeETH = `${json.ethereum.usd_24h_change.toFixed(2)}%`;
        data.GOLD = `$${json['pax-gold'].usd}`;
      } catch(e) {}
      for (const s of ['^GSPC','^IXIC','^DXY']) {
        try {
          const res = await fetch(`https://financialmodelingprep.com/api/v3/quote/${encodeURIComponent(s)}?apikey=demo`);
          const json = await res.json();
          if (s === '^GSPC') data.SP = `$${json[0].price}`;
          if (s === '^IXIC') data.IXIC = `$${json[0].price}`;
          if (s === '^DXY') data.DXY = `$${json[0].price}`;
        } catch(e) {}
      }
      try {
        const res = await fetch('https://api.alternative.me/fng/?limit=1');
        data.FNG = (await res.json()).data[0].value;
      } catch(e) {}
      return data;
    }
    async function updateUI(pr) {
      document.getElementById('priceBTC').textContent = pr.BTC;
      document.getElementById('changeBTC').textContent = pr.changeBTC;
      document.getElementById('changeBTC').className = pr.changeBTC.startsWith('-') ? 'change-down' : 'change-up';
      document.getElementById('sentimentBTC').textContent = `F&G: ${pr.FNG}`;
      document.getElementById('priceETH').textContent = pr.ETH;
      document.getElementById('changeETH').textContent = pr.changeETH;
      document.getElementById('changeETH').className = pr.changeETH.startsWith('-') ? 'change-down' : 'change-up';
      document.getElementById('sentimentETH').textContent = `F&G: ${pr.FNG}`;
      document.getElementById('priceGOLD').textContent = pr.GOLD;
      document.getElementById('priceSP').textContent = pr.SP;
      document.getElementById('priceIXIC').textContent = pr.IXIC;
      document.getElementById('priceDXY').textContent = pr.DXY;
    }
    async function loadHeatmap(days) {
      document.getElementById('loading').style.display = 'block';
      const series = await Promise.all(symbols.map(s => fetchSeries(s.label, days)));
      const matrix = series.map((a, i) => series.map((b, j) => pearson(a, b)));
      Plotly.newPlot('heatmap', [{ x: labels, y: labels, z: matrix, type: 'heatmap', colorscale: 'RdBu', reversescale: true }], { margin: { t: 20, b: 50, l: 50, r: 20 }, xaxis: { side: 'bottom' }, yaxis: { autorange: 'reversed' } }, { responsive: true });
      document.getElementById('loading').style.display = 'none';
    }
    document.addEventListener('DOMContentLoaded', async () => {
      document.getElementById('date').textContent = new Date().toLocaleString();
      new bootstrap.Popover(document.querySelector('[data-bs-toggle="popover"]'));
      const sel = document.getElementById('rangeSelect');
      sel.addEventListener('change', () => loadHeatmap(sel.value));
      await loadHeatmap(sel.value);
      const prices = await fetchPrices();
      await updateUI(prices);
      document.getElementById('exportBtn').addEventListener('click', () => {
        html2canvas(document.getElementById('heatmap')).then(canvas => {
          const link = document.createElement('a'); link.download = `heatmap_${sel.value}d.png`; link.href = canvas.toDataURL(); link.click();
        });
      });
    });
  </script>
</body>
</html>
