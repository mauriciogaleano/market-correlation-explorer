<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Market Correlation Explorer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
  <style>
    /* heatmap slightly larger and no gaps between cells */
    #heatmap {
      width: 103%;
      max-width: 721px;
      height: 412px;
      margin: auto;
    }
    /* remove lines/gaps between heatmap cells */
    .plotly .heatmaplayer .hm {
      stroke-width: 0 !important;
    }
    /* toolbar unchanged */
    .toolbar { display:flex; justify-content:center; gap:8px; margin-bottom:1rem; }
    .spark { width: 100px; height: 30px; vertical-align: middle; }
    /* news stacked vertically, left aligned, vignette after each item */
    .news-section ul {
      padding-left: 0;
      list-style: none;
    }
    .news-section li {
      margin-bottom: 1rem;
      position: relative;
      padding-right: 1.5em;
    }
    .news-section li::after {
      content: "ðŸ“°";
      position: absolute;
      right: 0;
      top: 0;
    }
  </style>
</head>
<body class="p-3">
  <h3 class="text-center">Market Correlation Explorer</h3>
  <p id="currentDate" class="text-center mb-4"></p>

  <div class="toolbar">
    <select id="rangeSelect" class="form-select form-select-sm" style="width:auto">
      <option value="1">1 Day</option>
      <option value="7" selected>1 Week</option>
      <option value="30">1 Month</option>
    </select>
    <button id="exportBtn" class="btn btn-primary btn-sm">Export as PNG</button>
  </div>

  <div id="heatmap"></div>

  <h5 class="mt-4">Current Prices & Changes</h5>
  <ul id="priceList" class="list-group mb-4">
    <li class="list-group-item">
      Bitcoin: <span id="priceBTC">â€¦</span> (<span id="changeBTC">â€¦</span>) 
      <span id="sentBTC" class="badge bg-info">F&G â€¦</span>
      <img id="sparkBTC" class="spark" src="" alt="">
      <a href="https://www.tradingview.com/symbols/BTCUSD/" target="_blank">ðŸ“ˆ</a>
      <a href="https://www.coindesk.com/price/bitcoin" target="_blank">ðŸ“°</a>
    </li>
    <li class="list-group-item">
      Ethereum: <span id="priceETH">â€¦</span> (<span id="changeETH">â€¦</span>) 
      <span id="sentETH" class="badge bg-info">F&G â€¦</span> 
      <img id="sparkETH" class="spark" src="" alt="">
      <a href="https://www.tradingview.com/symbols/ETHUSD/" target="_blank">ðŸ“ˆ</a>
      <a href="https://www.coindesk.com/price/ethereum" target="_blank">ðŸ“°</a>
    </li>
    <li class="list-group-item">
      Gold (USD/oz): <span id="priceGOLD">â€¦</span> (<span id="changeGOLD">â€¦</span>) 
      <span id="sentGOLD" class="badge bg-secondary">N/A</span>
      <img id="sparkGOLD" class="spark" src="" alt="">
      <a href="https://www.tradingview.com/symbols/XAUUSD/" target="_blank">ðŸ“ˆ</a>
      <a href="https://www.kitco.com/news/" target="_blank">ðŸ“°</a>
    </li>
    <li class="list-group-item">
      S&P 500: <span id="priceSP">N/A</span> (<span id="changeSP">N/A</span>) 
      <span id="sentSP" class="badge bg-secondary">N/A</span>
      <img id="sparkSP" class="spark" src="" alt="">
      <a href="https://www.tradingview.com/symbols/SPX/" target="_blank">ðŸ“ˆ</a>
      <a href="https://www.reuters.com/markets/us/" target="_blank">ðŸ“°</a>
    </li>
  </ul>

  <div class="news-section">
    <h5>Latest News</h5>
    <ul id="feedCrypto"></ul>
    <ul id="feedMetals"></ul>
    <ul id="feedMarket"></ul>
  </div>

  <h5 class="mt-4">Tweets</h5>
  <p>
    <a class="twitter-timeline" data-height="300" href="https://twitter.com/CoinDesk">Tweets by CoinDesk</a><br>
    <a class="twitter-timeline" data-height="300" href="https://twitter.com/BlackRock">Tweets by BlackRock</a>
  </p>
  <script async src="https://platform.twitter.com/widgets.js"></script>

  <script>
    document.getElementById('currentDate').innerText = new Date().toLocaleString();

    const STATIC_HEAT = [
      [1,0.8,-0.1,0.3],
      [0.8,1,-0.2,0.4],
      [-0.1,-0.2,1,-0.1],
      [0.3,0.4,-0.1,1]
    ], LBL = ['BTC','ETH','GOLD','SP'];

    function drawStatic() {
      Plotly.newPlot('heatmap',[{
        z: STATIC_HEAT, x:LBL, y:LBL,
        type:'heatmap', colorscale:'RdBu', reversescale:true,
        xgap: 0, ygap: 0
      }],{margin:{l:50,t:20,r:20,b:50},yaxis:{autorange:'reversed'}});
    }

    async function fetchPrices() {
      const j = u=>fetch(u).then(r=>r.json()).catch(()=>null);
      const cg = await j('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,pax-gold&vs_currencies=usd&include_24hr_change=true');
      document.getElementById('priceBTC').innerText = '$'+cg.bitcoin.usd;
      document.getElementById('changeBTC').innerText = cg.bitcoin.usd_24h_change.toFixed(2)+'%';
      document.getElementById('sentBTC').innerText = 'F&G: 63';

      document.getElementById('priceETH').innerText = '$'+cg.ethereum.usd;
      document.getElementById('changeETH').innerText = cg.ethereum.usd_24h_change.toFixed(2)+'%';
      document.getElementById('sentETH').innerText = 'F&G: 63';

      document.getElementById('priceGOLD').innerText = '$'+cg['pax-gold'].usd;
      document.getElementById('changeGOLD').innerText = 'N/A';
    }

    async function loadSparks() {
      const qc = s=>`https://quickchart.io/chart?c={type:'sparkline',data:{datasets:[{data:${JSON.stringify(s)} }]}}`;
      const cgHist = d=>fetch(d).then(r=>r.json()).then(j=>j.prices.map(p=>p[1])).catch(()=>[]);
      document.getElementById('sparkBTC').src = qc(await cgHist('https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=7'));
      document.getElementById('sparkETH').src = qc(await cgHist('https://api.coingecko.com/api/v3/coins/ethereum/market_chart?vs_currency=usd&days=7'));
      document.getElementById('sparkGOLD').src = qc(await cgHist('https://api.coingecko.com/api/v3/coins/pax-gold/market_chart?vs_currency=usd&days=7'));
      document.getElementById('sparkSP').src = qc(await fetch('https://financialmodelingprep.com/api/v3/historical-price-full/^GSPC?timeseries=7&apikey=demo')
        .then(r=>r.json()).then(j=>j.historical.map(h=>h.close).reverse()).catch(()=>[]));
    }

    async function loadNews() {
      const feed = (url,id) => fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`)
        .then(r=>r.json())
        .then(j=>j.items.slice(0,3).forEach(it=>{
          const li=document.createElement('li');
          li.innerHTML=`<a href="${it.link}" target="_blank">${it.title}</a>`;
          document.getElementById(id).append(li);
        })).catch(()=>{});
      feed('https://www.coindesk.com/arc/outboundfeeds/rss/?outputType=xml','feedCrypto');
      feed('https://www.mining.com/feed/','feedMetals');
      feed('https://www.reuters.com/markets/us/feed/','feedMarket');
    }

    document.getElementById('exportBtn').onclick = ()=>{
      Plotly.toImage('heatmap',{format:'png',height:412,width:721})
        .then(dataUrl=>{const a=document.createElement('a');a.href=dataUrl;a.download='heatmap.png';a.click();});
    };

    drawStatic();
    fetchPrices();
    loadSparks();
    loadNews();
  </script>
</body>
</html>
