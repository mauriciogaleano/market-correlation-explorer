<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Market Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <style>
        #heatmap-container {
            overflow-x: auto;
        }

        #correlation-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        #correlation-table th,
        #correlation-table td {
            border: 1px solid #dee2e6;
            padding: 0.5rem;
            text-align: center;
        }

        .positive-corr {
            background-color: #d4edda;
        }

        .negative-corr {
            background-color: #f8d7da;
        }

        .spark {
            width: 100px;
            height: 30px;
            vertical-align: middle;
        }

        .news-item {
            margin-bottom: 0.5rem;
        }

        .asset-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .asset-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .asset-links a {
            margin-left: 0.5rem;
        }
    </style>
</head>

<body class="p-3">
    <div class="container">
        <h2 class="text-center mb-4">Market Dashboard</h2>
        <p id="currentDate" class="text-center mb-4"></p>

        <div class="toolbar">
            <select id="rangeSelect" class="form-select form-select-sm" style="width:auto">
                <option value="7">7 Days</option>
                <option value="30">30 Days</option>
                <option value="90">90 Days</option>
            </select>
        </div>

        <div id="heatmap-container">
            <h5>Correlation Heatmap</h5>
            <table id="correlation-table">
                <thead>
                    <tr>
                        <th></th>
                        <th>BTC</th>
                        <th>ETH</th>
                        <th>GOLD</th>
                        <th>SPX</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th>BTC</th>
                        <td>1</td>
                        <td id="corr-BTC-ETH"></td>
                        <td id="corr-BTC-GOLD"></td>
                        <td id="corr-BTC-SPX"></td>
                    </tr>
                    <tr>
                        <th>ETH</th>
                        <td></td>
                        <td>1</td>
                        <td id="corr-ETH-GOLD"></td>
                        <td id="corr-ETH-SPX"></td>
                    </tr>
                    <tr>
                        <th>GOLD</th>
                        <td></td>
                        <td></td>
                        <td>1</td>
                        <td id="corr-GOLD-SPX"></td>
                    </tr>
                    <tr>
                        <th>SPX</th>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td>1</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <h5>Asset Prices</h5>
        <ul id="assetList" class="list-group mb-4">
            <li class="list-group-item asset-row">
                <div class="asset-info">
                    <span>Bitcoin (BTC):</span>
                    <span id="priceBTC">...</span>
                    (<span id="changeBTC">...</span>)
                    <img id="sparkBTC" class="spark" src="" alt="">
                </div>
                <div class="asset-links">
                    <a href="https://www.tradingview.com/symbols/BTCUSD/" target="_blank">ðŸ“ˆ</a>
                    <a href="https://www.coindesk.com/price/bitcoin" target="_blank">ðŸ“°</a>
                    </div>
            </li>
            <li class="list-group-item asset-row">
                <div class="asset-info">
                    <span>Ethereum (ETH):</span>
                    <span id="priceETH">...</span>
                    (<span id="changeETH">...</span>)
                    <img id="sparkETH" class="spark" src="" alt="">
                </div>
                <div class="asset-links">
                    <a href="https://www.tradingview.com/symbols/ETHUSD/" target="_blank">ðŸ“ˆ</a>
                    <a href="https://www.coindesk.com/price/ethereum" target="_blank">ðŸ“°</a>
                    </div>
            </li>
            <li class="list-group-item asset-row">
                <div class="asset-info">
                    <span>Gold (XAU):</span>
                    <span id="priceGOLD">...</span>
                    (<span id="changeGOLD">...</span>)
                    <img id="sparkGOLD" class="spark" src="" alt="">
                </div>
                <div class="asset-links">
                    <a href="https://www.tradingview.com/symbols/XAUUSD/" target="_blank">ðŸ“ˆ</a>
                    <a href="https://www.kitco.com/news/" target="_blank">ðŸ“°</a>
                    </div>
            </li>
            <li class="list-group-item asset-row">
                <div class="asset-info">
                    <span>S&P 500 (SPX):</span>
                    <span id="priceSPX">...</span>
                    (<span id="changeSPX">...</span>)
                    <img id="sparkSPX" class="spark" src="" alt="">
                </div>
                <div class="asset-links">
                    <a href="https://www.tradingview.com/symbols/SPX/" target="_blank">ðŸ“ˆ</a>
                    <a href="https://www.reuters.com/markets/us/" target="_blank">ðŸ“°</a>
                    </div>
            </li>
        </ul>

        <h5>Latest News</h5>
        <div class="row">
            <div class="col-md-4">
                <h6>Crypto News</h6>
                <ul id="feedCrypto" class="list-unstyled"></ul>
            </div>
            <div class="col-md-4">
                <h6>Metals News</h6>
                <ul id="feedMetals" class="list-unstyled"></ul>
            </div>
            <div class="col-md-4">
                <h6>Market News</h6>
                <ul id="feedMarket" class="list-unstyled"></ul>
            </div>
        </div>
    </div>

    <script>
        //  Date Display
        document.getElementById('currentDate').innerText = moment().format('MMMM Do YYYY, h:mm:ss a');
        setInterval(() => {
            document.getElementById('currentDate').innerText = moment().format('MMMM Do YYYY, h:mm:ss a');
        }, 1000); // Update every second

        //  Asset Symbols
        const assets = {
            'BTC': {
                name: 'bitcoin',
                priceId: 'priceBTC',
                changeId: 'changeBTC',
                sparkId: 'sparkBTC',
                coingecko: true,
                fmp: false
            },
            'ETH': {
                name: 'ethereum',
                priceId: 'priceETH',
                changeId: 'changeETH',
                sparkId: 'sparkETH',
                coingecko: true,
                fmp: false
            },
            'GOLD': {
                name: 'XAU',
                priceId: 'priceGOLD',
                changeId: 'changeGOLD',
                sparkId: 'sparkGOLD',
                coingecko: false,
                fmp: true,
                fmpSymbol: 'XAU'
            },
            'SPX': {
                name: '^GSPC',
                priceId: 'priceSPX',
                changeId: 'changeSPX',
                sparkId: 'sparkSPX',
                coingecko: false,
                fmp: true,
                fmpSymbol: '^GSPC'
            }
        };

        //  Fetch Prices and Changes
        async function fetchPrices() {
            const coingeckoIds = Object.keys(assets).filter(key => assets[key].coingecko).map(key => assets[key].name).join(',');
            const fmpSymbols = Object.keys(assets).filter(key => assets[key].fmp).map(key => assets[key].fmpSymbol || assets[key].name).join(',');

            let cgData = {};
            if (coingeckoIds) {
                const cgUrl = `https://api.coingecko.com/api/v3/simple/price?ids=${coingeckoIds}&vs_currencies=usd&include_24hr_change=true`;
                const cgResponse = await fetch(cgUrl);
                if (cgResponse.ok) {
                    cgData = await cgResponse.json();
                } else {
                    console.error("Error fetching CoinGecko data:", cgResponse.status);
                    // TODO: Handle error gracefully (e.g., display a message to the user)
                }
            }

            let fmpData = {};
            if (fmpSymbols) {
                const fmpUrl = `https://financialmodelingprep.com/api/v3/quote/${fmpSymbols}?apikey=demo`; //  Replace 'demo' with your API key
                const fmpResponse = await fetch(fmpUrl);
                if (fmpResponse.ok) {
                    const fmpArray = await fmpResponse.json();
                    fmpData = fmpArray.reduce((acc, item) => {
                        acc[item.symbol] = item;
                        return acc;
                    }, {});

                } else {
                    console.error("Error fetching FMP data:", fmpResponse.status);
                    // TODO: Handle error gracefully
                }
            }

            for (const key in assets) {
                const asset = assets[key];
                if (asset.coingecko && cgData[asset.name]) {
                    document.getElementById(asset.priceId).innerText = '$' + cgData[asset.name].usd;
                    document.getElementById(asset.changeId).innerText = cgData[asset.name].usd_24h_change ? cgData[asset.name].usd_24h_change.toFixed(2) + '%' : 'N/A';
                } else if (asset.fmp && fmpData[asset.fmpSymbol || asset.name]) {
                    document.getElementById(asset.priceId).innerText = '$' + fmpData[asset.fmpSymbol || asset.name].price;
                    document.getElementById(asset.changeId).innerText = fmpData[asset.fmpSymbol || asset.name].changePercent ? fmpData[asset.fmpSymbol || asset.name].changePercent.toFixed(2) + '%' : 'N/A';
                } else {
                    document.getElementById(asset.priceId).innerText = 'N/A';
                    document.getElementById(asset.changeId).innerText = 'N/A';
                }
            }
        }

        //  Load Sparklines
        async function loadSparks() {
            const qc = s => `https://quickchart.io/chart?c={type:'sparkline',data:{datasets:[{data:${JSON.stringify(s)} }]}}`;

            for (const key in assets) {
                const asset = assets[key];
                let sparkData = [];

                if (asset.coingecko) {
                    const cgUrl = `https://api.coingecko.com/api/v3/coins/${asset.name}/market_chart?vs_currency=usd&days=7`;
                    const cgResponse = await fetch(cgUrl);
                    if (cgResponse.ok) {
                        const cgJson = await cgResponse.json();
                        sparkData = cgJson.prices.map(p => p[1]);
                    } else {
                        console.error("Error fetching CoinGecko sparkline data:", cgResponse.status);
                        // TODO: Handle error
                    }
                } else if (asset.fmp) {
                    const fmpUrl = `https://financialmodelingprep.com/api/v3/historical-price-full/${asset.fmpSymbol || asset.name}?timeseries=7&apikey=demo`; // Replace 'demo' with your API key
                    const fmpResponse = await fetch(fmpUrl);
                    if (fmpResponse.ok) {
                        const fmpJson = await fmpResponse.json();
                        sparkData = fmpJson.historical.map(h => h.close).reverse();
                    } else {
                        console.error("Error fetching FMP sparkline data:", fmpResponse.status);
                        // TODO: Handle error
                    }
                }

                document.getElementById(asset.sparkId).src = qc(sparkData);
            }
        }

        //  Load News Feeds
        async function loadNews() {
            const feed = (url, id) => fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`)
                .then(r => r.json())
                .then(j => {
                    if (j.items) {
                        j.items.slice(0, 3).forEach(it => {
                            const li = document.createElement('li');
                            li.classList.add('news-item');
                            li.innerHTML = `<a href="<span class="math-inline">\{it\.link\}" target\="\_blank"\></span>{it.title}</a>`;
                            document.getElementById(id).append(li);
                        });
                    } else {
                        console.error(`Error fetching news from ${url}:`, j);
                        // TODO: Handle error
                    }
                })
                .catch(error => {
                    console.error(`Error fetching news from ${url}:`, error);
                    // TODO: Handle error
                });

            feed('https://www.coindesk.com/arc/outboundfeeds/rss/?outputType=xml', 'feedCrypto');
            feed('https://www.mining.com/feed/', 'feedMetals');
            feed('https://www.reuters.com/markets/us/feed/', 'feedMarket');
        }

        //  Calculate Correlation (Simplified)
        async function updateCorrelationTable(timeRange) {
            const historicalData = {};

            // Fetch historical data for all assets
            for (const key in assets) {
                const asset = assets[key];
                historicalData[key] = await fetchHistoricalData(asset, timeRange);
            }

            // Calculate and display correlations
            const assetKeys = Object.keys(assets);
            for (let i = 0; i < assetKeys.length; i++) {
                for (let j = i + 1; j < assetKeys.length; j++) {
                    const asset1 = assetKeys[i];
                    const asset2 = assetKeys[j];
                    const corr = correlation(historicalData[asset1], historicalData[asset2]);
                    const cellId = `corr-<span class="math-inline">\{asset1\}\-</span>{asset2}`;
                    const cell = document.getElementById(cellId);
                    cell.innerText = corr.toFixed(2);
                    if (corr > 0.5) {
                        cell.classList.add("positive-corr");
                    } else if (corr < -0.5) {
                        cell.classList.add("negative-corr");
                    }
                    document.getElementById(`corr-<span class="math-inline">\{asset2\}\-</span>{asset1}`).innerText = corr.toFixed(2);
                    document.getElementById(`corr-<span class="math-inline">\{asset2\}\-</span>{asset1}`).classList.add(corr > 0.5 ? "positive-corr" : corr < -0.5 ? "negative-corr" : "");

                }
            }
        }

        // Fetch historical data for correlation calculation
        async function fetchHistoricalData(asset, days) {
            let data = [];
            try {
                if (asset.coingecko) {
                    const cgUrl = `https://api.coingecko.com/api/v3/coins/<span class="math-inline">\{asset\.name\}/market\_chart?vs\_currency\=usd&days\=</span>{days}`;
                    const response = await fetch(cgUrl);
                    if (response.ok) {
                        const json = await response.json();
                        data = json.prices.map(p => p[1]);
                    } else {
                        console.error(`Error fetching CoinGecko historical data for ${asset.name}: ${response.status}`);
                    }
                } else if (asset.fmp) {
                    const fmpUrl
